<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TioTV Admin Console v3.5</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<style>
:root { --primary: #ff4f00; --dark: #0f172a; --darker: #020617; --surface: #1e293b; --border: #334155; --text: #f1f5f9; }
body { font-family: 'Outfit', sans-serif; background-color: var(--darker); color: var(--text); overflow-x: hidden; }
.glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
.btn-primary { background: linear-gradient(135deg, #ff4f00, #ff8700); color: white; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 79, 0, 0.3); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 79, 0, 0.5); }
.input-box { background: var(--dark); border: 1px solid var(--border); color: white; transition: 0.3s; }
.input-box:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(255, 79, 0, 0.2); }
.nav-item { transition: all 0.3s; opacity: 0.7; }
.nav-item:hover, .nav-item.active { opacity: 1; color: var(--primary); background: rgba(255, 79, 0, 0.1); }
.nav-item.active { font-weight: 600; border-bottom: 2px solid var(--primary); }
.media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; }
.media-item { position: relative; aspect-ratio: 1; overflow: hidden; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
.media-item:hover { border-color: var(--primary); transform: scale(1.02); }
.media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--darker); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
.loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
@keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.animate-pulse-fast { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
</style>
</head>
<body class="min-h-screen flex flex-col">
<div id="auth-view" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
    <div class="glass p-10 rounded-2xl w-full max-w-md text-center border-t-4 border-[#ff4f00] shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[#ff4f00] to-transparent"></div>
        <h1 class="text-5xl font-extrabold text-white mb-2 tracking-tighter">tio<span class="text-[#ff4f00]">TV</span></h1>
        <p class="text-gray-400 mb-8 text-sm uppercase tracking-widest">Control Center v3.5</p>
        <form id="login-form" class="space-y-5">
            <div class="relative">
                <i class="fas fa-user absolute left-4 top-3.5 text-gray-500"></i>
                <input type="text" id="user" placeholder="Username" class="input-box w-full py-3 pl-12 pr-4 rounded-xl">
            </div>
            <div class="relative">
                <i class="fas fa-lock absolute left-4 top-3.5 text-gray-500"></i>
                <input type="password" id="pass" placeholder="Password" class="input-box w-full py-3 pl-12 pr-4 rounded-xl">
            </div>
            <button type="submit" id="login-action-btn" class="btn-primary w-full py-3.5 rounded-xl font-bold text-lg shadow-lg">Authenticate</button>
        </form>
        <p id="login-msg" class="mt-4 text-red-500 text-sm hidden"></p>
    </div>
</div>

<div id="app-view" class="hidden flex-1 flex flex-col">
    <header class="glass sticky top-0 z-40 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="text-2xl font-bold tracking-tight">tio<span class="text-[#ff4f00]">TV</span></div>
                <button id="logout-btn" class="text-gray-400 hover:text-white transition"><i class="fas fa-power-off mr-2"></i>Logout</button>
            </div>
            <nav class="flex space-x-1 overflow-x-auto pb-0 hide-scrollbar">
                <button class="nav-item px-4 py-3 text-sm whitespace-nowrap" data-tab="banners"><i class="fas fa-layer-group mr-2"></i>Banners</button>
                <button class="nav-item px-4 py-3 text-sm whitespace-nowrap" data-tab="tv_categories"><i class="fas fa-list mr-2"></i>Categories</button>
                <button class="nav-item px-4 py-3 text-sm whitespace-nowrap" data-tab="liveTV"><i class="fas fa-satellite-dish mr-2"></i>Live TV</button>
                <button class="nav-item px-4 py-3 text-sm whitespace-nowrap" data-tab="moviesSections"><i class="fas fa-clapperboard mr-2"></i>Movies</button>
                <button class="nav-item px-4 py-3 text-sm whitespace-nowrap" data-tab="cricketSections"><i class="fas fa-baseball-bat-ball mr-2"></i>Cricket</button>
                <button class="nav-item px-4 py-3 text-sm whitespace-nowrap text-[#ff4f00]" data-tab="mediaLibrary"><i class="fas fa-photo-film mr-2"></i>Media Library</button>
            </nav>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <h2 id="page-title" class="text-3xl font-bold text-white"></h2>
            <div class="flex gap-3">
                <button id="save-order-btn" class="hidden btn-primary bg-emerald-600 px-5 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-check mr-2"></i>Save Order</button>
                <button id="add-btn" class="btn-primary px-5 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-plus mr-2"></i>Add New</button>
            </div>
        </div>

        <div id="content-container" class="space-y-6"></div>

        <div id="sub-section" class="hidden mt-8 border-l-4 border-[#ff4f00] pl-6 py-2 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white">Section Items</h3>
                    <p id="sub-subtitle" class="text-gray-400 text-sm"></p>
                </div>
                <div class="flex gap-2">
                     <button id="save-sub-order-btn" class="hidden btn-primary bg-emerald-600 px-4 py-1.5 rounded text-sm"><i class="fas fa-check mr-1"></i>Save Order</button>
                    <button id="add-sub-btn" class="btn-primary bg-gray-700 hover:bg-gray-600 px-4 py-1.5 rounded text-sm"><i class="fas fa-plus mr-1"></i>Add Item</button>
                </div>
            </div>
            <div id="sub-content" class="glass rounded-xl overflow-hidden"></div>
        </div>
    </main>
</div>

<div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-xl p-4">
        <div class="glass rounded-2xl shadow-2xl border-t-4 border-[#ff4f00] flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold"></h3>
                <button id="modal-close" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar space-y-4"></div>
            <div class="p-5 border-t border-gray-700 flex justify-end gap-3 bg-[#0f172a]/50">
                <button id="modal-cancel" class="px-5 py-2.5 rounded-xl text-gray-300 hover:bg-gray-800 transition">Cancel</button>
                <button id="modal-save" class="btn-primary px-6 py-2.5 rounded-xl font-bold">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div id="media-picker-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-md"></div>
    <div class="absolute inset-4 glass rounded-xl flex flex-col overflow-hidden">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#0f172a]">
            <h3 class="text-lg font-bold"><i class="fas fa-photo-film text-[#ff4f00] mr-2"></i>Select Media</h3>
            <div class="flex gap-3">
                <label class="btn-primary px-4 py-1.5 rounded cursor-pointer text-sm">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Upload New
                    <input type="file" id="picker-upload-input" hidden accept="image/*,video/*">
                </label>
                <button id="picker-close" class="text-gray-400 hover:text-white"><i class="fas fa-times text-lg"></i></button>
            </div>
        </div>
        <div id="picker-grid" class="flex-1 overflow-y-auto p-4 media-grid bg-[#020617]"></div>
        <div id="picker-loader" class="absolute inset-0 bg-black/80 flex items-center justify-center z-10 hidden">
            <div class="loader"></div>
        </div>
    </div>
</div>

<div id="toast" class="fixed top-6 right-6 z-[100] transform translate-x-[150%] transition-all duration-500"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, deleteDoc, addDoc, updateDoc, getDoc, serverTimestamp, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const CLOUD_NAME = "dwgvvzbvn";
    const UPLOAD_PRESET = "storyapp";
    
    const app = initializeApp({ apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY", authDomain: "movie-92659.firebaseapp.com", projectId: "movie-92659", storageBucket: "movie-92659.appspot.com", messagingSenderId: "1090734362509", appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4" });
    const db = getFirestore(app);

    const UI = {
        auth: document.getElementById('auth-view'), app: document.getElementById('app-view'),
        loginForm: document.getElementById('login-form'), loginMsg: document.getElementById('login-msg'),
        content: document.getElementById('content-container'), subSec: document.getElementById('sub-section'), subContent: document.getElementById('sub-content'),
        modal: document.getElementById('modal'), modalBody: document.getElementById('modal-body'),
        picker: document.getElementById('media-picker-modal'), pickerGrid: document.getElementById('picker-grid'),
        toast: document.getElementById('toast')
    };

    const State = {
        user: 't', pass: 't', tab: 'banners', parentId: null, parentColl: null, editId: null,
        targetInput: null, sortMain: null, sortSub: null
    };

    const SCHEMAS = {
        banners: [
            { k: 'title', l: 'Title', t: 'text' },
            { k: 'posterUrl', l: 'Banner Image (16:9)', t: 'image' },
            { k: 'link', l: 'Target Action', t: 'text' },
            { k: 'order', t: 'hidden', v: 0 }
        ],
        tv_categories: [ { k: 'name', l: 'Category Name', t: 'text' } ],
        liveTV: [
            { k: 'name', l: 'Channel Name', t: 'text' },
            { k: 'logoUrl', l: 'Logo (Square)', t: 'image' },
            { k: 'streamUrl', l: 'Stream URL (m3u8)', t: 'text' },
            { k: 'category', l: 'Category', t: 'select', src: 'tv_categories' },
            { k: 'order', t: 'hidden', v: 0 }
        ],
        sections: [ { k: 'title', l: 'Section Title', t: 'text' }, { k: 'order', t: 'hidden', v: 0 } ],
        items: (type) => [
            { k: 'title', l: 'Content Title', t: 'text' },
            { k: 'posterUrl', l: 'Poster URL', t: 'image' },
            { k: 'videoUrl', l: 'Video Source', t: 'video' },
            { k: 'keyId', l: 'DRM Key ID', t: 'text', cond: v => v && v.includes('.mpd') },
            { k: 'contentKey', l: 'DRM Key', t: 'text', cond: v => v && v.includes('.mpd') },
            { k: 'description', l: 'Synopsis', t: 'textarea' },
            { k: 'order', t: 'hidden', v: 0 },
            ...(type === 'cricket' ? [
                { k: 'startTime', l: 'Start Time', t: 'datetime' },
                { k: 'endTime', l: 'End Time', t: 'datetime' }
            ] : [])
        ]
    };

    const App = {
        init() {
            if(localStorage.getItem('auth')) this.loadApp();
            
            UI.loginForm.onsubmit = (e) => {
                e.preventDefault();
                if(document.getElementById('user').value === State.user && document.getElementById('pass').value === State.pass) {
                    localStorage.setItem('auth', 1);
                    this.loadApp();
                } else {
                    UI.loginMsg.textContent = "Access Denied"; UI.loginMsg.classList.remove('hidden');
                }
            };

            document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };
            document.querySelectorAll('.nav-item').forEach(b => b.onclick = () => this.setTab(b.dataset.tab));
            document.getElementById('add-btn').onclick = () => this.openModal();
            document.getElementById('add-sub-btn').onclick = () => this.openModal(true);
            document.getElementById('modal-close').onclick = document.getElementById('modal-cancel').onclick = () => UI.modal.classList.add('hidden');
            document.getElementById('modal-save').onclick = () => this.saveData();
            document.getElementById('modal-backdrop').onclick = () => UI.modal.classList.add('hidden');
            document.getElementById('save-order-btn').onclick = () => this.saveOrder(State.tab, State.sortMain);
            document.getElementById('save-sub-order-btn').onclick = () => this.saveOrder(`${State.parentColl}/${State.parentId}/items`, State.sortSub);
            document.getElementById('picker-close').onclick = () => UI.picker.classList.add('hidden');
            document.getElementById('picker-upload-input').onchange = (e) => this.handleUpload(e.target.files[0], true);
        },

        loadApp() {
            UI.auth.classList.add('hidden'); UI.app.classList.remove('hidden');
            this.setTab('banners');
        },

        setTab(tab) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.tab === tab));
            State.tab = tab;
            State.parentId = null;
            UI.subSec.classList.add('hidden');
            document.getElementById('add-btn').classList.toggle('hidden', tab === 'mediaLibrary');
            document.getElementById('save-order-btn').classList.add('hidden');
            document.getElementById('page-title').innerHTML = tab === 'mediaLibrary' ? '<i class="fas fa-photo-film text-[#ff4f00] mr-3"></i>Media Library' : `<i class="fas fa-layer-group text-[#ff4f00] mr-3"></i>${tab.replace(/([A-Z])/g, ' $1').trim()}`;
            
            if(tab === 'mediaLibrary') this.renderLibrary();
            else this.fetchData(tab);
        },

        async fetchData(coll) {
            UI.content.innerHTML = '<div class="flex justify-center p-10"><div class="loader"></div></div>';
            try {
                const snap = await getDocs(query(collection(db, coll), orderBy('order', 'asc')));
                const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                this.renderTable(data, coll);
            } catch(e) { this.toast(e.message, 'err'); }
        },

        renderTable(data, coll, isSub = false) {
            const con = isSub ? UI.subContent : UI.content;
            if(!data.length) { con.innerHTML = '<div class="p-8 text-center text-gray-500 italic">No data available</div>'; return; }
            
            const isSec = coll.includes('Sections') && !isSub;
            let h = `<div class="overflow-x-auto"><table class="w-full text-left border-collapse">
                <thead class="bg-[#1e293b] text-xs uppercase text-gray-400 font-semibold tracking-wider"><tr>
                    <th class="p-4 w-10"></th><th class="p-4">Name/Title</th><th class="p-4">Status</th><th class="p-4">Preview</th>${isSec?'<th class="p-4">Manage</th>':''}<th class="p-4 text-right">Actions</th>
                </tr></thead><tbody class="divide-y divide-gray-800 sort-list">`;
            
            data.forEach(d => {
                const img = d.posterUrl || d.logoUrl;
                let badge = '<span class="text-gray-500 text-xs">-</span>';
                
                if(d.startTime && d.endTime) {
                    const now = new Date();
                    const start = d.startTime.toDate ? d.startTime.toDate() : new Date(d.startTime);
                    const end = d.endTime.toDate ? d.endTime.toDate() : new Date(d.endTime);

                    if(now < start) {
                        badge = `<div class="flex flex-col"><span class="bg-blue-900/50 text-blue-400 border border-blue-700/50 px-2 py-1 rounded text-xs font-bold w-fit">Upcoming</span><span class="text-[10px] text-gray-400 mt-1">${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>`;
                    } else if(now >= start && now <= end) {
                        badge = `<span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-bold animate-pulse-fast"><i class="fas fa-circle text-[8px] mr-1"></i>LIVE</span>`;
                    } else {
                        badge = `<span class="bg-emerald-900/50 text-emerald-400 border border-emerald-700/50 px-2 py-1 rounded text-xs font-bold">Finished</span>`;
                    }
                }

                h += `<tr data-id="${d.id}" class="hover:bg-white/5 transition group">
                    <td class="p-4 text-gray-600 cursor-grab handle group-hover:text-[#ff4f00]"><i class="fas fa-grip-vertical"></i></td>
                    <td class="p-4 font-medium text-white">${d.title || d.name}</td>
                    <td class="p-4">${badge}</td>
                    <td class="p-4">${img ? `<img src="${img}" class="h-10 w-16 object-cover rounded bg-black/50 border border-gray-700">` : '-'}</td>
                    ${isSec ? `<td class="p-4"><button class="text-sky-400 hover:text-sky-300 text-sm font-semibold open-sub" data-id="${d.id}" data-t="${d.title}"><i class="fas fa-folder-open mr-1"></i> Open Items</button></td>` : ''}
                    <td class="p-4 text-right space-x-2">
                        <button class="text-gray-400 hover:text-yellow-400 transition edit-item" data-id="${d.id}"><i class="fas fa-pen"></i></button>
                        <button class="text-gray-400 hover:text-red-500 transition del-item" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            h += '</tbody></table></div>';
            con.innerHTML = h;

            const sort = new Sortable(con.querySelector('.sort-list'), { 
                handle: '.handle', animation: 150, 
                onEnd: () => document.getElementById(isSub ? 'save-sub-order-btn' : 'save-order-btn').classList.remove('hidden') 
            });
            if(isSub) State.sortSub = sort; else State.sortMain = sort;

            con.querySelectorAll('.edit-item').forEach(b => b.onclick = () => this.openModal(isSub, b.dataset.id));
            con.querySelectorAll('.del-item').forEach(b => b.onclick = () => this.deleteItem(coll, b.dataset.id, isSub));
            if(isSec) con.querySelectorAll('.open-sub').forEach(b => b.onclick = () => this.loadSub(b.dataset.id, b.dataset.t));
        },

        async loadSub(id, title) {
            State.parentId = id; State.parentColl = State.tab;
            UI.subSec.classList.remove('hidden');
            document.getElementById('sub-subtitle').textContent = `Manage items for: ${title}`;
            document.getElementById('save-sub-order-btn').classList.add('hidden');
            UI.subContent.innerHTML = '<div class="p-4 text-center"><div class="loader scale-50"></div></div>';
            
            const snap = await getDocs(query(collection(db, `${State.tab}/${id}/items`), orderBy('order', 'asc')));
            this.renderTable(snap.docs.map(d => ({id: d.id, ...d.data()})), `${State.tab}/${id}/items`, true);
            UI.subSec.scrollIntoView({behavior:'smooth'});
        },

        async renderLibrary(forPicker = false) {
            const con = forPicker ? UI.pickerGrid : UI.content;
            con.innerHTML = '<div class="col-span-full flex justify-center py-10"><div class="loader"></div></div>';
            
            if(!forPicker) {
                con.innerHTML = `<div class="col-span-full bg-[#1e293b] p-8 rounded-xl border-2 border-dashed border-gray-700 text-center mb-6 hover:border-[#ff4f00] transition group cursor-pointer relative">
                    <input type="file" id="lib-upload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*,video/*">
                    <i class="fas fa-cloud-arrow-up text-4xl text-gray-500 group-hover:text-[#ff4f00] mb-3 transition"></i>
                    <p class="font-semibold text-lg">Click to Upload Media</p>
                    <p class="text-sm text-gray-500">Supports Images & Videos</p>
                </div><div id="lib-grid" class="media-grid w-full"></div>`;
                document.getElementById('lib-upload').onchange = (e) => this.handleUpload(e.target.files[0], false);
            }

            const grid = forPicker ? con : document.getElementById('lib-grid');
            try {
                const snap = await getDocs(query(collection(db, 'media_library'), orderBy('createdAt', 'desc')));
                grid.innerHTML = '';
                snap.docs.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = 'media-item group';
                    el.innerHTML = d.type === 'video' 
                        ? `<video src="${d.url}" muted onmouseover="this.play()" onmouseout="this.pause()"></video><i class="fas fa-play-circle absolute top-2 right-2 text-white drop-shadow-md"></i>`
                        : `<img src="${d.url}" loading="lazy">`;
                    
                    if(!forPicker) {
                        const del = document.createElement('button');
                        del.className = 'absolute bottom-2 right-2 bg-red-600 text-white p-1.5 rounded opacity-0 group-hover:opacity-100 transition';
                        del.innerHTML = '<i class="fas fa-trash text-xs"></i>';
                        del.onclick = (e) => { e.stopPropagation(); this.deleteMedia(doc.id); };
                        el.appendChild(del);
                    }

                    el.onclick = () => {
                        if(forPicker) {
                            State.targetInput.value = d.url;
                            State.targetInput.dispatchEvent(new Event('input'));
                            UI.picker.classList.add('hidden');
                        } else {
                            navigator.clipboard.writeText(d.url);
                            this.toast('URL Copied!');
                        }
                    };
                    grid.appendChild(el);
                });
            } catch(e) { console.error(e); }
        },

        async handleUpload(file, isPicker) {
            if(!file) return;
            const loader = isPicker ? document.getElementById('picker-loader') : null;
            if(loader) loader.classList.remove('hidden'); else this.toast('Uploading...', 'info');

            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', UPLOAD_PRESET);
            fd.append('cloud_name', CLOUD_NAME);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: 'POST', body: fd });
                const data = await res.json();
                if(data.secure_url) {
                    const type = file.type.startsWith('video') ? 'video' : 'image';
                    await addDoc(collection(db, 'media_library'), { url: data.secure_url, type, createdAt: serverTimestamp() });
                    
                    if(isPicker) {
                        State.targetInput.value = data.secure_url;
                        State.targetInput.dispatchEvent(new Event('input'));
                        UI.picker.classList.add('hidden');
                    } else {
                        this.renderLibrary();
                    }
                    this.toast('Upload Successful!');
                } else throw new Error('Upload Failed');
            } catch(e) { this.toast(e.message, 'err'); }
            if(loader) loader.classList.add('hidden');
        },

        async deleteMedia(id) {
            if(confirm('Delete this media?')) {
                await deleteDoc(doc(db, 'media_library', id));
                this.renderLibrary();
            }
        },

        async openModal(isSub = false, id = null) {
            State.editId = id;
            const coll = isSub ? State.parentColl : State.tab;
            const type = coll === 'cricketSections' ? 'cricket' : 'movie';
            const schema = isSub ? SCHEMAS.items(type) : (coll.includes('Sections') ? SCHEMAS.sections : SCHEMAS[coll]);
            
            document.getElementById('modal-title').textContent = (id ? 'Edit ' : 'Add ') + (isSub ? 'Item' : coll);
            UI.modalBody.innerHTML = '<div class="text-center py-10"><div class="loader"></div></div>';
            UI.modal.classList.remove('hidden');

            let html = '';
            for(const f of schema) {
                if(f.t === 'hidden') continue;
                let input = '';
                if(f.t === 'textarea') input = `<textarea id="inp_${f.k}" class="input-box w-full p-3 rounded-lg h-24" placeholder="${f.l}"></textarea>`;
                else if(f.t === 'select') {
                    const cats = await getDocs(collection(db, f.src));
                    input = `<select id="inp_${f.k}" class="input-box w-full p-3 rounded-lg bg-[#0f172a]"><option value="">Select...</option>${cats.docs.map(c=>`<option>${c.data().name}</option>`).join('')}</select>`;
                } else if(['text', 'image', 'video', 'datetime'].includes(f.t)) {
                    const isMedia = f.t === 'image' || f.t === 'video';
                    input = `<div class="flex gap-2"><input type="${f.t==='datetime'?'datetime-local':'text'}" id="inp_${f.k}" class="input-box w-full p-3 rounded-lg" placeholder="${f.l}">
                    ${isMedia ? `<button type="button" class="btn-primary px-4 rounded-lg pick-media" data-target="inp_${f.k}"><i class="fas fa-folder-open"></i></button>` : ''}</div>
                    ${isMedia ? `<div id="prev_${f.k}" class="mt-2 hidden w-full h-32 rounded bg-black/40 object-contain border border-gray-700"></div>` : ''}`;
                }
                html += `<div id="wrap_${f.k}" class="mb-1"><label class="block text-gray-400 text-xs font-bold uppercase mb-1">${f.l}</label>${input}</div>`;
            }
            UI.modalBody.innerHTML = html;

            UI.modalBody.querySelectorAll('.pick-media').forEach(b => b.onclick = () => {
                State.targetInput = document.getElementById(b.dataset.target);
                UI.picker.classList.remove('hidden');
                this.renderLibrary(true);
            });

            schema.forEach(f => {
                if(f.t === 'image' || f.t === 'video') {
                    const i = document.getElementById(`inp_${f.k}`);
                    const p = document.getElementById(`prev_${f.k}`);
                    i.oninput = () => {
                        const v = i.value;
                        if(v) {
                            p.innerHTML = f.t==='video' ? `<video src="${v}" controls class="h-full w-full"></video>` : `<img src="${v}" class="h-full w-full object-contain">`;
                            p.classList.remove('hidden');
                        } else p.classList.add('hidden');
                        if(f.k === 'videoUrl') checkCond();
                    };
                }
            });

            const checkCond = () => {
                const v = document.getElementById('inp_videoUrl')?.value;
                schema.forEach(f => {
                    if(f.cond) document.getElementById(`wrap_${f.k}`).style.display = f.cond(v) ? 'block' : 'none';
                });
            };

            if(id) {
                const path = isSub ? `${State.parentColl}/${State.parentId}/items` : coll;
                const d = (await getDoc(doc(db, path, id))).data();
                schema.forEach(f => {
                    const el = document.getElementById(`inp_${f.k}`);
                    if(!el || f.t === 'hidden') return;
                    if(f.t === 'datetime' && d[f.k]) {
                        const dt = d[f.k].toDate(); dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
                        el.value = dt.toISOString().slice(0,16);
                    } else el.value = d[f.k] || '';
                    if(f.t === 'image' || f.t === 'video') el.dispatchEvent(new Event('input'));
                });
            }
            checkCond();
        },

        async saveData() {
            const isSub = document.getElementById('modal-title').textContent.includes('Item');
            const coll = isSub ? `${State.parentColl}/${State.parentId}/items` : State.tab;
            const schema = isSub ? SCHEMAS.items(State.parentColl==='cricketSections'?'cricket':'movie') : (State.tab.includes('Sections')?SCHEMAS.sections:SCHEMAS[State.tab]);
            
            const data = {};
            schema.forEach(f => {
                if(f.t === 'hidden') { if(!State.editId) data[f.k] = f.v; return; }
                const el = document.getElementById(`inp_${f.k}`);
                if(!el || el.closest('div').style.display === 'none') return;
                if(f.t === 'datetime') data[f.k] = el.value ? Timestamp.fromDate(new Date(el.value)) : null;
                else data[f.k] = el.value;
            });
            data.updatedAt = serverTimestamp();

            try {
                if(State.editId) await updateDoc(doc(db, coll, State.editId), data);
                else await addDoc(collection(db, coll), { ...data, createdAt: serverTimestamp() });
                
                UI.modal.classList.add('hidden');
                this.toast('Saved Successfully');
                if(isSub) this.loadSub(State.parentId, document.getElementById('sub-subtitle').textContent.split(': ')[1]);
                else this.fetchData(State.tab);
            } catch(e) { this.toast(e.message, 'err'); }
        },

        async saveOrder(path, sort) {
            if(!sort) return;
            const b = writeBatch(db);
            sort.toArray().forEach((id, i) => b.update(doc(db, path, id), { order: i }));
            await b.commit();
            this.toast('Order Updated');
            document.getElementById(path.includes('items')?'save-sub-order-btn':'save-order-btn').classList.add('hidden');
        },

        async deleteItem(coll, id, isSub) {
            if(!confirm('Delete this item?')) return;
            const path = isSub ? `${State.parentColl}/${State.parentId}/items` : coll;
            await deleteDoc(doc(db, path, id));
            this.toast('Deleted');
            if(isSub) this.loadSub(State.parentId, document.getElementById('sub-subtitle').textContent.split(': ')[1]);
            else this.fetchData(coll);
        },

        toast(msg, type='success') {
            UI.toast.innerHTML = `<div class="glass px-6 py-4 rounded-xl border-l-4 ${type==='err'?'border-red-500 text-red-100':'border-[#ff4f00] text-white'} shadow-2xl flex items-center gap-3"><i class="fas ${type==='err'?'fa-exclamation-circle':'fa-check-circle'}"></i> ${msg}</div>`;
            UI.toast.classList.remove('translate-x-[150%]');
            setTimeout(() => UI.toast.classList.add('translate-x-[150%]'), 3000);
        }
    };

    App.init();
</script>
</body>
</html>
